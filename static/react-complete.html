
<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PDRM • Transkripsi Audio & Minit (React)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;700&display=swap" rel="stylesheet">
  
  <!-- React CDN -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Use the EXACT same CSS from index.html -->
  <link rel="stylesheet" href="index.html" />
  <style>
    /* Import styles from the original index.html - copy all CSS here */
    :root {
      --navy-900: #0a1733; --navy-800: #0f2249; --navy-700: #183569; --navy-600: #1f4788;
      --accent-royal: #2563eb; --gold-500: #d4af37; --gold-600: #b9961f; --bg: #f8fafc;
      --card: #ffffff; --muted: #64748b; --text: #0f172a; --success: #059669; --error: #dc2626;
      --warning: #d97706; --border: #e2e8f0; --shadow-sm: 0 1px 3px rgba(0,0,0,.05);
      --shadow-md: 0 4px 20px rgba(10, 23, 51, .08); --shadow-lg: 0 8px 30px rgba(10, 23, 51, .12);
      --radius: 12px; --sidebar-w: 280px; --header-h: 68px;
      --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-display: 'Plus Jakarta Sans', var(--font-sans);
    }
    [data-theme="dark"] { --bg: #0b1220; --card: #111827; --text: #f1f5f9; --muted: #94a3b8; --border: #1e293b; --shadow-md: 0 8px 30px rgba(0,0,0,.5); --shadow-lg: 0 12px 36px rgba(0,0,0,.6); }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; font-family: 'Inter', system-ui; color: var(--text); background: var(--bg); display: grid; grid-template-columns: var(--sidebar-w) 1fr; grid-template-rows: var(--header-h) 1fr; grid-template-areas: "sidebar header" "sidebar main"; height: 100vh; overflow: hidden; }
    .scroll-container { overflow-y: auto; height: 100%; padding: 32px 40px; }
    header { grid-area: header; height: var(--header-h); display: flex; align-items: center; justify-content: space-between; padding: 0 24px 0 20px; background: linear-gradient(180deg, rgba(10,23,51,.75), rgba(10,23,51,.65)); color: #fff; position: fixed; top: 0; left: var(--sidebar-w); right: 0; z-index: 50; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .crest { width: 40px; height: 40px; display: grid; place-items: center; border-radius: 10px; background: linear-gradient(135deg, var(--gold-500), var(--gold-600)); }
    .brand h1 { margin: 0; font: 700 18px "Plus Jakarta Sans", Inter, sans-serif; }
    .brand small { display: block; font-weight: 500; opacity: .9; }
    .header-actions { display: flex; align-items: center; gap: 8px; }
    .chip { padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,.25); font-size: 12px; opacity: .95; }
    .toggle { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 8px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.25); }
    .toggle input { display: none; }
    aside { grid-area: sidebar; background: linear-gradient(180deg, var(--navy-900), var(--navy-800)); color: #e2e8f0; position: fixed; top: 0; left: 0; width: var(--sidebar-w); height: 100vh; overflow: auto; z-index: 40; }
    .side-top { padding: 16px; }
    .user-card { display: flex; align-items: center; gap: 10px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 10px 12px; }
    .avatar { width: 32px; height: 32px; border-radius: 8px; background: #1f2a44; display: grid; place-items: center; color: #fff; font-weight: 700; }
    .user-card a { color: #dbeafe; text-decoration: none; font-weight: 600; }
    .nav { margin: 14px 8px; display: flex; flex-direction: column; gap: 4px; }
    .nav button { width: 100%; background: transparent; color: #e2e8f0; text-align: left; border: 0; padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 12px; cursor: pointer; font-weight: 500; transition: all 0.2s ease; }
    .nav button:hover { background: rgba(255,255,255,.08); transform: translateX(2px); }
    .nav button.active { background: linear-gradient(90deg, rgba(212,175,55,.25), rgba(31,71,136,.3)); color: #fff; border: 1px solid rgba(255,255,255,.15); box-shadow: 0 2px 8px rgba(0,0,0,.2); }
    main { grid-area: main; overflow: hidden; position: relative; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 20px; }
    .page-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
    .page-header h2 { font-size: 28px; font-weight: 700; font-family: 'Plus Jakarta Sans', Inter, system-ui, sans-serif; color: var(--navy-800); }
    .card { background: var(--card); border: 1px solid var(--border); box-shadow: var(--shadow-md); border-radius: var(--radius); margin-bottom: 32px; transition: var(--transition); }
    .card .card-hd { padding: 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .card .card-hd h2 { margin: 0; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 12px; color: var(--navy-800); }
    .card .card-bd { padding: 24px; }
    .grid-2 { display: grid; grid-template-columns: 1.2fr .8fr; gap: 40px; margin-top: 32px; }
    .form-row { display: grid; gap: 16px; grid-template-columns: 1fr 1fr; margin-bottom: 16px; }
    label { font-weight: 600; font-size: 13px; color: var(--muted); display: inline-block; margin-bottom: 8px; }
    .control { width: 100%; padding: 12px 16px; border: 1px solid var(--border); background: var(--card); color: var(--text); border-radius: 10px; font-size: 14px; outline: none; transition: all 0.2s ease; }
    .control:focus { border-color: var(--navy-600); box-shadow: 0 0 0 4px rgba(31,71,136,.1); }
    .dropzone { border: 2px dashed rgba(31,71,136,.35); padding: 40px 24px; border-radius: 12px; background: linear-gradient(180deg, rgba(31,71,136,.04), rgba(212,175,55,.04)); display: grid; place-items: center; gap: 16px; cursor: pointer; transition: all 0.2s ease; }
    .dropzone:hover { border-color: var(--navy-600); transform: translateY(-1px); }
    .dz-help { color: var(--muted); font-size: 14px; text-align: center; font-weight: 500; }
    .file-name { margin-top: 8px; font-size: 13px; color: var(--muted); font-weight: 500; }
    .btn { appearance: none; border: 0; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 12px; transition: all 0.2s ease; font-size: 14px; }
    .btn-primary { color: #fff; background: linear-gradient(135deg, var(--navy-700), var(--navy-600)); box-shadow: 0 6px 16px rgba(31,71,136,.25); }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); }
    .btn-outline { background: transparent; border: 1px solid var(--navy-600); color: var(--navy-700); }
    .btn-danger { background: linear-gradient(135deg, #b91c1c, #dc2626); color: #fff; }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .textarea { width: 100%; min-height: 260px; padding: 20px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); line-height: 1.75; resize: vertical; font-size: 14px; outline: none; transition: all 0.2s ease; }
    .textarea:focus { border-color: var(--navy-600); box-shadow: 0 0 0 4px rgba(31,71,136,.1); }
    .badge { font-size: 12px; padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); background: rgba(31,71,136,.06); }
    .status { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; padding: 14px 24px; border-radius: 12px; box-shadow: var(--shadow-lg); display: none; align-items: center; gap: 12px; font-weight: 600; }
    .status[aria-hidden="false"] { display: flex; }
    .status.success { background: rgba(6, 95, 70, 0.1); color: #065f46; border: 1px solid #059669; }
    .status.error { background: rgba(153, 27, 27, 0.1); color: #991b1b; border: 1px solid #dc2626; }
    .status.loading { background: rgba(30, 64, 175, 0.1); color: #1e40af; border: 1px solid #2563eb; }
    .meta-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    @media (max-width: 1200px) { .grid-2 { grid-template-columns: 1fr; gap: 32px; } }
    @media (max-width: 680px) { .form-row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // Constants
    const LOCAL_STORAGE_KEY = 'transcription_text';
    const PROCESSED_TRANSCRIPTION_KEY = 'processed_transcription';
    const METADATA_KEY = 'meeting_metadata';
    const SYSTEM_PROMPTS_KEY = 'system_prompts';
    const DEFAULT_SYSTEM_PROMPT = `Convert the meeting transcript into a clean PDRM meeting minutes document in Bahasa Malaysia.

Start with header information:
[Extract descriptive meeting title from context]
Rujukan: [Generate reference like PDRM/MM/2025/001]
Bil. Mesyuarat: [Infer number like 1/2025]
Tarikh: [Extract or infer date]
Masa: [Extract meeting duration]
Tempat: [Extract location]

Then provide content sections:

## KEHADIRAN
1.1 [Name/Title] (Pengerusi) [Hadir]
1.2 [Name/Title] [Hadir/Tidak Hadir]

## AGENDA 1: [EXTRACT MAIN TOPIC]

For each point, classify correctly:
- **[Makluman]** - ONLY for pure information with no action required
- **[Tindakan: Specific Person/Department]** - For ALL action items, identify WHO is responsible
- **[Perbincangan]** - For ongoing discussions needing follow-up

CRITICAL: For action items like training, follow-ups, implementations - ALWAYS specify the responsible party, never use [Makluman].

Examples:
✅ Attend refresher course [Tindakan: Pegawai Ahmad]
✅ Submit report by Friday [Tindakan: MCSB]
✅ Schedule follow-up meeting [Tindakan: Ketua Unit]
❌ Training required [Makluman] ← WRONG

Use sub-numbering (1.1.1, 1.1.2) for related items.

## PENUTUP
1. Mesyuarat ditangguhkan pada [time]
2. Disediakan oleh: [name]
3. Disemak oleh: [name]

Output ONLY the structured content - no preambles or explanatory text.`;

    const PDRMApp = () => {
      // All state management
      const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
      const [selectedFile, setSelectedFile] = useState(null);
      const [maxWorkers, setMaxWorkers] = useState(6);
      const [model, setModel] = useState('Whisper');
      const [language, setLanguage] = useState('auto');
      const [transcription, setTranscription] = useState('');
      const [processedTranscription, setProcessedTranscription] = useState('');
      const [systemPrompt, setSystemPrompt] = useState('');
      const [systemPrompts, setSystemPrompts] = useState([]);
      const [selectedPromptId, setSelectedPromptId] = useState('default');
      const [isTranscribing, setIsTranscribing] = useState(false);
      const [isProcessing, setIsProcessing] = useState(false);
      const [status, setStatus] = useState({ message: '', type: '', visible: false });
      const [metadata, setMetadata] = useState({ rujukan: '', bil: '', tarikh: '', masa: '', tempat: '' });

      const fileInputRef = useRef(null);

      const showStatus = useCallback((message, type) => {
        setStatus({ message, type, visible: true });
        setTimeout(() => setStatus(prev => ({ ...prev, visible: false })), 3800);
      }, []);

      // Theme effect
      useEffect(() => {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
      }, [theme]);

      // Initialize data
      useEffect(() => {
        const savedTranscription = localStorage.getItem(LOCAL_STORAGE_KEY);
        if (savedTranscription) setTranscription(savedTranscription);
        
        const savedProcessed = localStorage.getItem(PROCESSED_TRANSCRIPTION_KEY);
        if (savedProcessed) setProcessedTranscription(savedProcessed);
        
        try {
          const savedMetadata = JSON.parse(localStorage.getItem(METADATA_KEY) || '{}');
          setMetadata(prev => ({ ...prev, ...savedMetadata }));
        } catch (err) {
          console.error('Failed to load metadata:', err);
        }
        
        initPrompts();
      }, []);

      const initPrompts = () => {
        let savedPrompts = [];
        try { savedPrompts = JSON.parse(localStorage.getItem(SYSTEM_PROMPTS_KEY) || '[]'); } catch { savedPrompts = []; }
        if (savedPrompts.length === 0) {
          savedPrompts.push({ id: 'default', name: 'Default Meeting Minutes', content: DEFAULT_SYSTEM_PROMPT });
          localStorage.setItem(SYSTEM_PROMPTS_KEY, JSON.stringify(savedPrompts));
        }
        setSystemPrompts(savedPrompts);
        setSystemPrompt(savedPrompts[0].content);
        setSelectedPromptId(savedPrompts[0].id);
      };

      // Save effects
      useEffect(() => { if (transcription) localStorage.setItem(LOCAL_STORAGE_KEY, transcription); }, [transcription]);
      useEffect(() => { if (processedTranscription) localStorage.setItem(PROCESSED_TRANSCRIPTION_KEY, processedTranscription); }, [processedTranscription]);
      useEffect(() => { localStorage.setItem(METADATA_KEY, JSON.stringify(metadata)); }, [metadata]);

      // File handlers
      const handleFileClick = () => fileInputRef.current?.click();
      const handleFileChange = (e) => setSelectedFile(e.target.files?.[0]);
      const handleFileDrop = (e) => {
        e.preventDefault();
        const file = e.dataTransfer.files?.[0];
        if (file) setSelectedFile(file);
      };

      // Transcription handler
      const handleTranscription = async (e) => {
        e.preventDefault();
        if (!selectedFile) { showStatus('Sila pilih fail audio terlebih dahulu', 'error'); return; }

        setIsTranscribing(true);
        showStatus('Memuat naik & mentranskripsi audio…', 'loading');

        const formData = new FormData();
        formData.append('file', selectedFile);
        formData.append('max_workers', maxWorkers.toString());
        formData.append('model_name', model);
        formData.append('language', language);

        try {
          const response = await fetch('/transcribe', { method: 'POST', body: formData });
          const data = await response.json();
          if (response.ok) {
            setTranscription(data.transcription);
            showStatus('Transkripsi selesai!', 'success');
          } else {
            showStatus(`Ralat: ${data.detail || 'Gagal mentranskripsi'}`, 'error');
          }
        } catch (err) {
          showStatus(`Ralat rangkaian: ${err.message}`, 'error');
        } finally {
          setIsTranscribing(false);
        }
      };

      // AI Processing
      const handleProcessing = async () => {
        if (!transcription.trim()) { showStatus('Tiada transkripsi untuk diproses', 'error'); return; }

        setIsProcessing(true);
        showStatus('Memproses minit…', 'loading');

        try {
          const response = await fetch('/completion', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify([
              { role: 'system', content: systemPrompt },
              { role: 'user', content: transcription }
            ])
          });

          const data = await response.json();
          if (response.ok) {
            setProcessedTranscription(data.text);
            showStatus('Minit berjaya diproses!', 'success');
          } else {
            showStatus(`Ralat: ${data.detail || 'Gagal memproses minit'}`, 'error');
          }
        } catch (err) {
          showStatus(`Ralat rangkaian: ${err.message}`, 'error');
        } finally {
          setIsProcessing(false);
        }
      };

      // System prompt handlers
      const handlePromptChange = (e) => {
        const selectedId = e.target.value;
        setSelectedPromptId(selectedId);
        const selectedPrompt = systemPrompts.find(p => p.id === selectedId);
        if (selectedPrompt) setSystemPrompt(selectedPrompt.content);
      };

      const handleSystemPromptChange = (e) => {
        const newContent = e.target.value;
        setSystemPrompt(newContent);
        const updatedPrompts = systemPrompts.map(p => p.id === selectedPromptId ? { ...p, content: newContent } : p);
        setSystemPrompts(updatedPrompts);
        localStorage.setItem(SYSTEM_PROMPTS_KEY, JSON.stringify(updatedPrompts));
      };

      const addSystemPrompt = () => {
        const name = prompt('Nama bagi arahan sistem baharu:');
        if (!name || !name.trim()) return;
        const newPrompt = { id: 'prompt_' + Date.now(), name: name.trim(), content: systemPrompt };
        const updatedPrompts = [...systemPrompts, newPrompt];
        setSystemPrompts(updatedPrompts);
        localStorage.setItem(SYSTEM_PROMPTS_KEY, JSON.stringify(updatedPrompts));
        setSelectedPromptId(newPrompt.id);
        showStatus('Arahan sistem ditambah', 'success');
      };

      const deleteSystemPrompt = () => {
        if (!selectedPromptId) { showStatus('Sila pilih arahan untuk dipadam', 'error'); return; }
        if (selectedPromptId === 'default') { showStatus('Arahan lalai tidak boleh dipadam', 'error'); return; }
        if (confirm('Padam arahan ini?')) {
          let updatedPrompts = systemPrompts.filter(p => p.id !== selectedPromptId);
          if (updatedPrompts.length === 0) {
            updatedPrompts.push({ id: 'default', name: 'Default Meeting Minutes', content: DEFAULT_SYSTEM_PROMPT });
          }
          setSystemPrompts(updatedPrompts);
          localStorage.setItem(SYSTEM_PROMPTS_KEY, JSON.stringify(updatedPrompts));
          setSystemPrompt(updatedPrompts[0].content);
          setSelectedPromptId(updatedPrompts[0].id);
          showStatus('Arahan dipadam', 'success');
        }
      };

      const clearSavedData = () => {
        if (confirm('Padam semua data simpanan (transkripsi, arahan sistem, hasil diproses, maklumat mesyuarat)?')) {
          localStorage.removeItem(LOCAL_STORAGE_KEY);
          localStorage.removeItem('system_prompts');
          localStorage.removeItem('processed_transcription');
          localStorage.removeItem(METADATA_KEY);
          setTranscription('');
          setProcessedTranscription('');
          setMetadata({ rujukan: '', bil: '', tarikh: '', masa: '', tempat: '' });
          initPrompts();
          showStatus('Data simpanan dibersihkan', 'success');
        }
      };

      const copyToClipboard = (text, buttonId) => {
        navigator.clipboard.writeText(text).then(() => {
          const button = document.getElementById(buttonId);
          if (button) {
            const originalText = button.textContent;
            button.textContent = 'Disalin!';
            setTimeout(() => { button.textContent = originalText; }, 1500);
          }
        }).catch(() => alert('Gagal menyalin ke papan klip'));
      };

      // PDRM PDF Download - EXACT same function as HTML version
      const downloadPdrmMinutes = async () => {
        if (!processedTranscription.trim()) {
          showStatus('Tiada transkripsi diproses untuk dimuat turun', 'error');
          return;
        }
        try {
          showStatus('Menjana PDF format PDRM...', 'loading');
          const fd = new FormData();
          fd.append('text', processedTranscription);
          fd.append('footer_text', '');
          fd.append('logo_path', 'static/asset/logo.png');
          const res = await fetch('/minutes/render?output_format=pdf', { method: 'POST', body: fd });
          const data = await res.json();
          if (!res.ok) throw new Error(data.detail || 'Render failed');
          const link = document.createElement('a');
          link.href = data.pdf_url;
          link.download = 'Minit Mesyuarat (PDRM).pdf';
          document.body.appendChild(link);
          link.click();
          link.remove();
          showStatus('PDF format PDRM berjaya dijana!', 'success');
        } catch (err) {
          showStatus(`Ralat: ${err.message}`, 'error');
        }
      };

      const downloadTranscription = async (format) => {
        if (!transcription) { showStatus('Tiada transkripsi untuk dimuat turun', 'error'); return; }
        try {
          showStatus(`Menjana fail ${format.toUpperCase()}…`, 'loading');
          const fd = new FormData();
          fd.append('text', transcription);
          fd.append('template', 'pdrm');
          fd.append('title', 'MINIT MESYUARAT');
          const url = new URL('/process_text', window.location.origin);
          url.searchParams.append('output_format', format);
          url.searchParams.append('template', 'pdrm');
          const response = await fetch(url, { method: 'POST', body: fd });
          const data = await response.json();
          if (response.ok) {
            const link = document.createElement('a');
            link.href = data[`${format}_url`];
            link.download = `minit.${format}`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            showStatus(`${format.toUpperCase()} sedia untuk dimuat turun`, 'success');
          }
        } catch (err) {
          showStatus(`Ralat rangkaian: ${err.message}`, 'error');
        }
      };

      const downloadProcessedTranscription = async (format) => {
        if (!processedTranscription) { showStatus('Tiada hasil diproses untuk dimuat turun', 'error'); return; }
        try {
          showStatus(`Menjana fail ${format.toUpperCase()}…`, 'loading');
          const fd = new FormData();
          fd.append('text', processedTranscription);
          fd.append('template', 'pdrm');
          fd.append('title', 'MINIT MESYUARAT');
          const url = new URL('/process_text', window.location.origin);
          url.searchParams.append('output_format', format);
          url.searchParams.append('template', 'pdrm');
          const response = await fetch(url, { method: 'POST', body: fd });
          const data = await response.json();
          if (response.ok) {
            const link = document.createElement('a');
            link.href = data[`${format}_url`];
            link.download = `minit-diproses.${format}`;
            document.body.appendChild(link);
            link.click();
            link.remove();
            showStatus(`${format.toUpperCase()} sedia untuk dimuat turun`, 'success');
          }
        } catch (err) {
          showStatus(`Ralat rangkaian: ${err.message}`, 'error');
        }
      };

      return (
        <div>
          {status.visible && (
            <div className={`status ${status.type}`} role="status" aria-live="polite" aria-hidden="false">
              {status.message}
            </div>
          )}

          <aside>
            <div className="side-top">
              <div className="user-card" aria-label="Maklumat Pengguna">
                <div className="avatar">AD</div>
                <div style={{lineHeight: '1.2'}}>
                  <div style={{fontWeight: 700, color: '#fff'}}>admin</div>
                  <a href="/logout" title="Log keluar">Log keluar</a>
                </div>
              </div>
            </div>
            <nav className="nav" aria-label="Navigasi Utama">
              <button className="active">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M12 1v22M5 8l7-7 7 7"/>
                </svg>
                Transkripsi
              </button>
              <button>
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                  <path d="M3 3v5h5M3 3l7 7"/><path d="M12 8a8 8 0 1 1-7 5"/>
                </svg>
                Sejarah
              </button>
              <button>
                <svg width="18" height="18" viewBox="0 0 